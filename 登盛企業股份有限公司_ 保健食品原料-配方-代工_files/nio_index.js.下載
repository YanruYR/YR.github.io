function showThisTag(){if( $('.ddsmoothmenu').length >0){var hs = 'http://'+location.hostname;var cc='';$('.ddsmoothmenu ul li a').each(function(i){if( $(this).attr('href').substring(0,1)=='/')cc=hs+$(this).attr('href');else cc=hs+'/'+$(this).attr('href');if(  cc==location.href ){$(this).css('color','red');return;}});}}
function pass2GetTxtDet(id){
	var test_id = parseInt(id,10);var inp=prompt(language.pw_please,'');
	if( !(inp=="" || inp==null ) ){
		$.ajax({type:"POST",dataType:'json',url:"get_pass_txt.php",data:"id="+test_id+'&p='+encodeURIComponent(inp),success: function(ret){if(ret.stat!=1)jAlert(decodeURIComponent(ret.message));else{$('#news_title_'+test_id).next().html(decodeURIComponent(ret.message));if($('#feedback_form').length>0)$('#feedback_form').submit(function(){feedbackTxt(); return false;});
	}}});}
}
function getTxtDet(tid){
	if($('#news_title_'+tid).next().html()==''){
$.ajax({type: "POST",dataType: 'json',url: "get_txt_detail.php",data: "id="+tid,
	success: function(ret){if(ret.stat!=1)jAlert(decodeURIComponent(ret.message));else{$('#news_title_'+tid).next().html(decodeURIComponent(ret.message));}}});}
}
function gotoDomPoint(obid){
	if(obid!=''){
	var $body=(window.opera)?(document.compatMode=="CSS1Compat"?$('html'):$('body')):$('html,body');
	$body.animate({scrollTop: $('#'+obid).offset().top}, 2000);}return false;
}
function putGood2Quotation(iid){
	if($('div.itemInfoList').length>0){
		var stv='';hav_opt=false;
		$('div.itemInfoList input').each(function(){var tv=$(this).val();var tdd=$(this).attr('id');var tvn=tdd.substr(0,10);
			if(tvn=='goods-type'){
				if( ($(this).attr('type')=='radio' || $(this).attr('type')=='checkbox') ){
					if($(this).prop('checked')==true){if(stv!='')stv+='&';stv+=tdd+'='+tv;}else hav_opt=true;
				}}})
		$.ajax({type: "POST",dataType: 'json',url: "/support_function.php?f=putGood2Quotation",data: "id="+iid+'&good_need_num='+$('#good_need_num').val()+'&gtv='+encodeURIComponent(stv),
			success: function(ret){
				if(ret.stat==1){if( $('#shop_quota_list_aid_div').length>0 && ret.list!=''){$('#shop_quota_list_aid_div').html(decodeURIComponent(ret.list));}
				}
				if(ret.message!='')jAlert(decodeURIComponent(ret.message));
			}});}
}
function putGood2Cart(iid,fromd,useby){
	if($('div.itemInfoList').length>0){
		var stv='', hav_opt=false , empty_reauired=false; 
		if(useby!='B')useby='';
		if(isNaN($('#good_need_num').val()) ||$('#good_need_num').val()=='')$('#good_need_num').val(1);
		$('div.itemInfoList input').each(function(){
			var tv=$(this).val();var tdd=$(this).attr('id');var tvn=tdd.substr(0,10);
			if(tvn=='goods-type'){
				if( ($(this).attr('type')=='radio' || $(this).attr('type')=='checkbox') ){
					if($(this).prop('checked')==true){
						if(stv!='')stv+='&';
						stv+=tdd+'='+tv;
					}else{ hav_opt=true;
						if( $(this).hasClass('reauired') ){
							var ok=new Array;
							$('input[name='+ $(this).attr('name') +']').each(function(){
								if($(this).prop('checked'))ok.push($(this).val());
							});
							if(ok.length==0){empty_reauired=true; 
								$('input[name='+ $(this).attr('name') +']').addClass('reauired_empty');
							}else{$('input[name='+ $(this).attr('name') +']').removeClass('reauired_empty');}
						}
					}
				}else{
					if(stv!='')stv+='&';stv+=tdd+'='+tv;
				}
			}
		});
		
		
		if($('div.itemInfoList select').length>0){
			$('div.itemInfoList select').each(function(){
				var tv=$(this).val();var tdd=$(this).attr('id');var tvn=tdd.substr(0,10);
				if(tvn=='goods-type'){
					if(tv!=''){if(stv!='')stv+='&';stv+=tdd+'='+tv;}
					else{hav_opt=true; 
						if( $(this).hasClass('reauired') ){
							var ok=new Array;
							$('select[name='+ $(this).attr('name') +']').each(function(){
								if($(this).prop('checked'))ok.push($(this).val());
							});
							if(ok.length==0){empty_reauired=true; 
								$('select[name='+ $(this).attr('name') +']').addClass('reauired_empty');
							}else{$('select[name='+ $(this).attr('name') +']').removeClass('reauired_empty');}
						}
					}
				}
			});
		}
		if(empty_reauired==true){jAlert(language.cho_gu);return false;}
		//if(hav_opt==true && stv==''){alert(language.cho_gu); return false;}
		$.ajax({type: "POST",dataType: 'json',url: "/support_function.php?f=putGood2car",
			data: "id="+iid+'&good_need_num='+$('#good_need_num').val()+'&gtv='+encodeURIComponent(stv)+ '&useby='+useby,
			success: function(ret){
				if(ret.stat==1){
					if(fromd!='undefined' && fromd=='box'){$.colorbox.close();}
					if($('#shop_car_info_totalnum_span').length>0){var tv=parseInt($('#shop_car_info_totalnum_span').html(),10);if(tv>=0){$('#shop_car_info_totalnum_span').html(tv+1)}}
					if(ret.message!='')jAlert(decodeURIComponent(ret.message),ret.title||'',null,{buttons:'no'});
				}else if(ret.message!='')jAlert(decodeURIComponent(ret.message),ret.title||'',null,{buttons:'no'});
				if( $('#shop_car_list_aid_div').length>0 && ret.list!=''){$('#shop_car_list_aid_div').html(decodeURIComponent(ret.list));}
				if($('#cart_info_float_div').length>0)$('#cart_info_float_div').html(decodeURIComponent(ret.list)).show();
			}});}	
}
function goodArriveNotice(gid,isu,obj){
	if(isNaN(gid))return false;
	$(obj).prop('disabled','disabled');
	var a=true;
	if(isu==0){
		a = !confirm("未登入會員，只能用匿名方式通知站長補貨。貨到將無法通知您！\n\n請按「取消」，然後登入會員，才能通知您商品到貨")?false:true;
	}
	if(a==true){
		$.ajax({type: "POST",dataType: 'json',url: "/support_function/goodarrivenotice/",
			data: "id="+gid,
			success: function(ret){
				if(ret.message!='')jAlert(decodeURIComponent(ret.message));
			}});
	}
}
function cacleGoodCartTotal(obj,aid){
	var a=parseInt(obj.value,10);
	if(a>0 && aid>=0){
		if($('#good_car_list_tr_'+aid).length>0){
			var b =parseInt($('#good_car_list_tr_'+aid +' td.tab_td_good_money').html(),10);
			$('#good_car_list_tr_'+aid+" td.tab_td_good_sub_total").html(a*b);
				if($('#recheck_car_but').css('display')=='none')$('#recheck_car_but').show();
				$('span.goods_car_total_money_span').addClass('strike');
				$('#checkout_shopcar_but').hide();
			if(b==0)jAlert(language.amnck);
		}
	}else if(obj.value==''){return false;}
	else{
		jAlert(language.entnum);
		return false;
	}
}
function changeBuyUse(aid,ut){
	if(isNaN(aid) || !(ut=='B' || ut=='C') )return false;
	$.ajax({type: "POST",dataType: 'json',async:false,url: "support_function.php?f=changebuyuse",
			data: "id="+aid+ '&ut='+ut,
			success: function(ret){
				if(ret.stat==1){
					if( $('#shop_car_list_aid_div').length>0 && ret.list_sub!=''){$('#shop_car_list_aid_div').html(decodeURIComponent(ret.list_sub));}
					if($('#shop_car_info_totalnum_span').length>0){var tv=parseInt($('#shop_car_info_totalnum_span').html(),10);if(tv>0){$('#shop_car_info_totalnum_span').html(tv-1)}}
					if(ret.lis!=''){
						if( $('#good_list_checkout_table').length>0){ $('#good_list_checkout_table').remove();$('#checkout_form').prepend(decodeURIComponent(ret.lis));}
						if($('#deliver_good_div').length>0 && $('#deliver_good_div').html()!=''){
							$('#checkout_shopcar_but').hide();
							getDeliverDoodForm(3);
						}
						if($('#cart_info_float_div').length>0){
							if(ret.list_sub=='')$('#cart_info_float_div').html('').hide();
							else $('#cart_info_float_div').html(decodeURIComponent(ret.list_sub)).show();
						}
					}
				}
				if(ret.message!='')jAlert(decodeURIComponent(ret.message));
			}});
}
function delGoodFromCarList(aid){
	if(confirm(language.cfdtc)){
		if(parseInt(aid)>0){
		$.ajax({type: "POST",dataType: 'json',async:false,url: "support_function.php?f=removeGood4car",
			data: "id="+aid,
			success: function(ret){
				if(ret.stat==1){
					if( $('#shop_car_list_aid_div').length>0 && ret.list_sub!=''){$('#shop_car_list_aid_div').html(decodeURIComponent(ret.list_sub));}
					if($('#shop_car_info_totalnum_span').length>0){var tv=parseInt($('#shop_car_info_totalnum_span').html(),10);if(tv>0){$('#shop_car_info_totalnum_span').html(tv-1)}}
					//$('#main_content').html(decodeURIComponent(ret.lis));
					if(ret.lis!=''){
						if( $('#good_list_checkout_table').length>0){ $('#good_list_checkout_table').remove();$('#checkout_form').prepend(decodeURIComponent(ret.lis));}
						if($('#deliver_good_div').length>0 && $('#deliver_good_div').html()!=''){
							$('#checkout_shopcar_but').hide();
							getDeliverDoodForm(3);
						}
						if($('#cart_info_float_div').length>0){
							if(ret.list_sub=='')$('#cart_info_float_div').html('').hide();
							else $('#cart_info_float_div').html(decodeURIComponent(ret.list_sub)).show();
						}
					}
				}
				if(ret.message!='')jAlert(decodeURIComponent(ret.message));
			}});}
	}
}
function recheckShopCarList(alr){
	var str='';if(alr!=false)alr= true;
	$('table.goods_list_tab .tab_td_good_num').each(function(){
		var a=$(this).attr('name');var b =$(this).val();if(str!='') str+='&';str+=a+'='+b
	});
	if(str!=''){
		$.ajax({type: "POST",dataType: 'json',async:false,url: "support_function.php?f=recheckGood4car",
			data: str,
			success: function(ret){
				if(ret.stat==1){
					if( $('#shop_car_list_aid_div').length>0 && ret.list_sub!=''){
						$('#shop_car_list_aid_div').html(decodeURIComponent(ret.list_sub));
					}
					if(ret.lis!=''){
						if( $('#good_list_checkout_table').length>0){ $('#good_list_checkout_table').remove();$('#checkout_form').prepend(decodeURIComponent(ret.lis));}
					}
					if($('#deliver_good_div').length>0 && $('#deliver_good_div').html()!=''){
						$('#checkout_shopcar_but').hide();
						getDeliverDoodForm(3);
					}
					if($('#cart_info_float_div').length>0){
						if(ret.list_sub=='') $('#cart_info_float_div').html('').hide();
						else $('#cart_info_float_div').html(decodeURIComponent(ret.list_sub)).show();
					}
					if($('#recheck_car_but').css('display')=='inline')$('#recheck_car_but').hide();
					
				}else{
					if(ret.lis!='')$('#main_content').html(decodeURIComponent(ret.lis));
					if(typeof(ret.err)=='object' && ret.err.length>0){for(var i in ret.err){$('table.goods_list_tab :text[name='+ret.err[i]+']').css('background-color','#FFBBBB');}
					}
				}
				if(ret.message!='' && alr==true)jAlert(decodeURIComponent(ret.message));
			}});}
}
function delGoodFromQuotaList(aid){
	if(confirm(language.cfdtq)){
		if(parseInt(aid)>0){
		$.ajax({type: "POST",dataType: 'json',async:false,url: "support_function.php?f=removeGood4quota",
			data: "id="+aid,
			success: function(ret){
				if(ret.stat==1){
					if( $('#shop_car_list_aid_div').length>0 && ret.list_sub!=''){$('#shop_car_list_aid_div').html(decodeURIComponent(ret.list_sub));}
					$('#main_content').html(decodeURIComponent(ret.lis));
				}
				if(ret.message!='')jAlert(decodeURIComponent(ret.message));
			}});}}
}
function recheckShopQuotaList(alr){
	var str='';if(alr!=false)alr= true;
	$('table.goods_list_tab .tab_td_good_num').each(function(){var a=$(this).attr('name');var b =$(this).val();if(str!='') str+='&';str+=a+'='+b;});
	if(str!=''){
		$.ajax({type: "POST",dataType: 'json',async:false,url: "support_function.php?f=recheckGood4quota",
			data: str,
			success: function(ret){
				if(ret.stat==1){
					if( $('#shop_car_list_aid_div').length>0 && ret.list_sub!=''){
						$('#shop_car_list_aid_div').html(decodeURIComponent(ret.list_sub));
					}
					if(ret.lis!=''){
						if( $('#good_list_checkout_table').length>0){ $('#good_list_checkout_table').remove();$('#checkout_form').prepend(decodeURIComponent(ret.lis));}
					}
					if($('#recheck_car_but').css('display')=='inline')$('#recheck_car_but').hide();
					if($('#deliver_good_div').length>0 && $('#deliver_good_div').html()!='')$('#checkout_shopcar_but').hide();
				}else{
					if(ret.lis!='')$('#main_content').html(decodeURIComponent(ret.lis));
					if(typeof(ret.err)=='object' && ret.err.length>0){
						for(var i in ret.err){$('table.goods_list_tab :text[name='+ret.err[i]+']').css('background-color','#FFBBBB');}
					}
				}
				if(ret.message!='' && alr==true)jAlert(decodeURIComponent(ret.message));
			}});	
	}
}
function getDeliverDoodForm(iid,rech){
	var tname=''; var temail=''; var tadd=''; var tzip=''; var ttel='';var tmob='';var tway='';var tmome='';var tm=0;
	if($('#deliver_good_div').length>0){
		if($('#deliver_name').length>0)tname=$('#deliver_name').val();
		if($('#deliv_email').length>0)temail=$('#deliv_email').val();
		if($('#deliv_add').length>0)tadd=$('#deliv_add').val();
		if($('#deliv_zip').length>0)tzip=$('#deliv_zip').val();
		if($('#deliv_tel').length>0)ttel=$('#deliv_tel').val();
		if($('#deliv_mobile').length>0)tmob=$('#deliv_mobile').val();
		if($('#tran_way_select').length>0)tway=$('#tran_way_select').val();
		if($('#good_order_memo_input').length>0)tmome=$('#good_order_memo_input').val();
	}
	if($('#goods_car_total_money_span').length>0)tm=parseInt($('#goods_car_total_money_span').html(),10);
	//if(iid==2)	recheckShopQuotaList(false);else if(iid==3 && rech!=false) recheckShopCarList(false);
	$('#checkout_shopcar_but').hide();
	$('.no_checkout_tr').hide();
	$.ajax({type: "POST",dataType: 'json', url: "support_function.php?f=getdeliverdoodform",
		data: "id="+iid+'&tm='+tm+'&token='+encodeURIComponent( $('#token').val()),
		success: function(ret){
			if(ret.stat==1){
				if($('div#deliver_good_div').length>0)$('#deliver_good_div').html(decodeURIComponent(ret.form));
				else $('#checkout_form').append('<div id="deliver_good_div">'+decodeURIComponent(ret.form)+'</div>');
				if($('#total_order_money').length>0)
					$('#total_order_money').html($('#goods_car_total_money_span').html());
				if($('#deliver_good_div').length>0){
					if($('#deliver_name').length>0 && tname!='')$('#deliver_name').val(tname);
					if($('#deliv_email').length>0 && temail!='')$('#deliv_email').val(temail);
					if($('#deliv_add').length>0 && tadd!='')$('#deliv_add').val(tadd);
					if($('#deliv_zip').length>0 && tzip!='')$('#deliv_zip').val(tzip);
					if($('#deliv_tel').length>0 && ttel!='')$('#deliv_tel').val(ttel);
					if($('#deliv_mobile').length>0 && tmob!='')$('#deliv_mobile').val(tmob);
					if($('#tran_way_select').length>0 && tway!='')$('#tran_way_select').val('');
					if($('#good_order_memo_input').length>0 && tmome!='')$('#good_order_memo_input').val(tmome);
				}
				if($('#use_bonus_point').length>0)$('#use_bonus_point').keyup(function(){checkBonusMax()});
				if($('#cart_info_float_div').length>0)$('#cart_info_float_div').html('').hide();
				if($('input[name=invoice_vehicle_type]').length>0){$('input[name=invoice_vehicle_type]').click(function(){$('#invoice_type_select_1').prop('checked','checked')});}
				if($('input[name=invoice_type_select]').length>0){
					$('input[name=invoice_type_select]').click(function(){if($(this).val()!=2)$('input[name=invoice_vehicle_type]').each(function(){$(this).prop('checked',false);});});
				}
				if($('#invoice_vehicle_mobile_conf').length>0){$('#invoice_vehicle_mobile_conf').keyup(function(){if( $(this).val()!=''){if($(this).val()!=$('#invoice_vehicle_mobile').val())$(this).next('span.tips').show();else $(this).next('span.tips').hide();}});}
				if($('#invoice_vehicle_natural_conf').length>0){$('#invoice_vehicle_natural_conf').keyup(function(){if( $(this).val()!=''){if($(this).val()!=$('#invoice_vehicle_natural').val())$(this).next('span.tips').show();else $(this).next('span.tips').hide();}});}
				if($('#stillgetpaperinvoice').length>0){$('#stillgetpaperinvoice').click(function(){if($(this).prop('checked')){var a=$(this).next('span.hide').html();if(!confirm(a)){$('#stillgetpaperinvoice').prop('checked',false)}else{/*$('#order_invoice_addr').next('span').show();*/$('#order_invoice_addr_2').focus(); }}});}
				if($('#invoice_vehicle_mobile').length>0){$('#invoice_vehicle_mobile').keyup(function(){if( $(this).val()!=''){$('#invoice_vehicle_type_1').prop('checked','checked');$('#invoice_type_select_1').prop('checked','checked');$('#invoice_vehicle_natural').val('');$('#invoice_vehicle_natural_conf').val('').next('span').hide();$('#invoice_live_code_input').val('');$('#order_invoice_id').val('');$('#order_invoice_title').val('');$('#order_invoice_addr').val('');}});}
				if($('#invoice_vehicle_natural').length>0){$('#invoice_vehicle_natural').keyup(function(){if( $(this).val()!='' ){$('#invoice_vehicle_type_2').prop('checked','checked');$('#invoice_type_select_1').prop('checked','checked');$('#invoice_vehicle_mobile').val('');$('#invoice_vehicle_mobile_conf').val('').next('span').hide();$('#invoice_live_code_input').val('');$('#order_invoice_id').val('');$('#order_invoice_title').val('');$('#order_invoice_addr').val('');}});}
				if($('#order_invoice_id').length>0 && $('input[name=invoice_type_select]').length>0){$('#order_invoice_id').keyup(function(){if($(this).val()!=''){$('#invoice_type_select_2').prop('checked','checked');$('#invoice_vehicle_mobile').val('');$('#invoice_vehicle_mobile_conf').val('');$('#invoice_vehicle_natural').val('');$('#invoice_vehicle_natural_conf').val('');$('#invoice_live_code_input').val('');$('input[name=invoice_vehicle_type]').each(function(){$(this).prop('checked',false)});}});}
				if($('#invoice_live_code_input').length>0){$('#invoice_live_code_input').keyup(function(){if($(this).val()!=''){$('#invoice_type_select_0').prop('checked','checked');$('input[name=invoice_vehicle_type]').each(function(){$(this).prop('checked',false)});$('#order_invoice_id').val('');$('#order_invoice_title').val('');$('#order_invoice_addr').val('');$('#invoice_vehicle_mobile').val('');$('#invoice_vehicle_mobile_conf').val('');$('#invoice_vehicle_natural').val('');$('#invoice_vehicle_natural_conf').val('');}});}
				$( "#invoice_choose_div" ).accordion();
				if( $('input[name=invoice_type_select]').length>0 ){
					$('input[name=invoice_type_select]').eq(0).prop('checked',true)
				}
			}
			if(ret.message!='')jAlert(decodeURIComponent(ret.message));
		}
	});
}
function getTranItemMoney(){
	var a=$('#tran_way_select').val();var tm=0;
	if(a!=''){
		if($('#goods_car_total_money_span').length>0)tm=parseInt($('#goods_car_total_money_span').html(),10);
		$.ajax({type: "POST",dataType: 'json', url: "support_function.php?f=gettranitemmoney",
		data: "id="+a+'&tm='+tm,
		success: function(ret){
			if(ret.stat==1){
				if($('div#tran_item_list_div').length>0)$('#tran_item_list_div').html(decodeURIComponent(ret.list));
			}
			if(ret.message!='')jAlert(decodeURIComponent(ret.message));
		}
		});
	}
}
function calcuOrderTotalMoney(ty,mm,inch){
	var a=0; var b,c;
	if(ty!=2)ty=1; if(inch!=1)inch=0;
	if($('#goods_car_total_money_span').length>0){a=parseInt($('#goods_car_total_money_span').html(),10);}
	if(isNaN(a))return false;
	else if($('#total_order_money').length>0){
		c=$('#bonus_tomoney').length>0?parseInt($('#bonus_tomoney').html(),10):0;
		if(!isNaN(c) && c>0){a-=c;}
		if($('#is_tran_free').length>0 && $('#is_tran_free').val()==1)b=a;
		else{if(ty==2){b=a+(a*(mm/100));}else{b=parseInt(a,10)+parseInt(mm,10);}}
		$('#total_order_money').html(b);
		if(inch==1){$('#order_pay_way_list_table').hide();}else $('#order_pay_way_list_table').show();
		if($('input:radio[name=chooe_cashflow_checkbox]').length>0){$('input:radio[name=chooe_cashflow_checkbox]').each(function(){$(this).prop('checked',false)});}
	}
	
}
function calcuOrderTotalMoneyAddCashflow(ty,mm){
	var alm='';var tws=''; var a=0;var b=0;var c=0;if(ty!=2)ty=1;if(isNaN(mm) || mm.length<1)mm=0;
	if($('input[name=tran_item_check]').length>0){
		$('input[name=tran_item_check]').each(function(i){if($(this).prop('checked')==true)tws=$(this).val();});}
	if($('#tran_way_select').length>0){if($('#tran_way_select').val()=='' || tws=='' )alm+=language.wexpemp;} 
	if($('#goods_car_total_money_span').length>0){a=parseInt($('#goods_car_total_money_span').html(),10);}
	if($('#total_order_money').length>0){b=parseInt($('#total_order_money').html(),10)}
	if(alm!=''){
		jAlert(alm);$('input[name=chooe_cashflow_checkbox]').each(function(i){$(this).prop('checked',false)}); return false;
	}else{
		if(mm>0){
			if(ty==1)c=b+mm;
			else if(ty==2) c=b+(b*(mm/100));
		}else c=b;
		if(c>0)$('#total_order_money_add_cashflow').html(c);
	}
}
function goodCheckout(){
	$('#checkout_form input:submit').prop('disabled','disabled' );var peri=0;var br = "<br>\n";
	var na=$.trim($('#deliver_name').val());var ea=$('#deliv_email').val();var adr=$('#deliv_add').val();
	var zip=$('#deliv_zip').val();var tel=$.trim($('#deliv_tel').val());
	var mob=$.trim($('#deliv_mobile').val());var st=$('#checkout_type').val();
	var good_order_memo_input ='';if($('#good_order_memo_input').length>0)good_order_memo_input=$('#good_order_memo_input').val();
	var bsp=$('#use_bonus_point').length>0?parseInt($('#use_bonus_point').val(),10):0;
	var msg='';var tws=''; var cfd='';
	if(na=='' || na==null || na.length==0){	if(st==2)msg+=language.wanemp+br;	else msg+=language.wqnemp+br;  $('#deliver_name').focus();}
  	if(na.length >12){ msg += language.wmxn+br;  $('#deliver_name').focus();}
  	if(ea==null || ea=='' || ea.length==0){msg+=language.wememp+br;$('#deliv_email').focus();}
  	if( !(Tools.isEmail(ea))){ msg += language.weminc+br; $('#deliv_email').focus();}
  	if(st==3 && adr==''){ msg+=language.wadremp+br;$('#deliv_add').focus();}
  	var reg = /^[\d|\-|\s]+$/;
	  if(tel.length==0 && mob.length==0){msg+=language.wtelemp+br;$('#deliv_mobile').focus();}
	  if(tel.length>0){if (!reg.test(tel)){   msg += language.wtelinc+br; }}
	  if(mob.length>0){if (!reg.test(mob)){   msg += language.wmobinc+br; }}
	if($('#tran_way_select').length>0 ){
		if($('#tran_way_select').val()==''){msg+=language.wexpemp+br;}
		else if($('input[name=tran_item_check]').length>0){
			tws=$('input[name=tran_item_check]:checked').val();
			if(tws==undefined)msg+=language.wexpemp+br;
		}
	}
	//if(tws==''){alert('請選擇運送方式');return false;}
	if($('input[name=chooe_cashflow_checkbox]').length>0 && $('#order_pay_way_list_table').css('display')!='none'){
		$('input[name=chooe_cashflow_checkbox]').each(function(i){
			if($(this).prop('checked')==true){cfd=$(this).val();if($('#chooe_cashflow_period_num_'+cfd).length>0)peri=$('#chooe_cashflow_period_num_'+cfd).val();}
		});
		if(cfd=='' || cfd==undefined)msg+=language.wpayemp+br;
	}
	var opn=($('#order_people_name').length>0)?$('#order_people_name').val():'';
	var opt=($('#order_people_tel').length>0)?$('#order_people_tel').val():'';
	var ope=($('#order_people_email').length>0)?$('#order_people_email').val():'';
	var oit=($('#order_invoice_title').length>0)?$('#order_invoice_title').val():'';
	var oia=($('#order_invoice_addr').length>0)?$('#order_invoice_addr').val():'';
	var oia2=$('#order_invoice_addr_2').length>0?$('#order_invoice_addr_2').val():'';
	var oiad=($('#order_invoice_id').length>0)?$('#order_invoice_id').val():'';
	var invt=0;var invv=0,invl='',invm='',invn='',inpg=0;
	if($('input[name=invoice_type_select]').length>0){
		$('input[name=invoice_type_select]').each(function(){ if($(this).prop('checked'))invt=$(this).val()})
	}
	if($('input[name=invoice_vehicle_type]').length>0){
		$('input[name=invoice_vehicle_type]').each(function(){ if($(this).prop('checked'))invv=$(this).val()});
		if(invt==2 && invv==0)msg+=language.invoice_veh_need;
	}
	if( $('#stillgetpaperinvoice').length>0 && $('#stillgetpaperinvoice').prop('checked') ){inpg=1; if(oia2=='')msg+='二聯發票地址未填寫';else oia=oia2;}
	if($('input[name=invoice_type_select]').length>0 && invt==0)msg+=language.invoice_need+br;
	else{
		if(invt==1 && $('#invoice_live_code_input').val()=='')$('#invoice_live_code_input').next().css({'color':'#F00'});
		else if(invt==2){
			if(invv==2 && $('#invoice_vehicle_mobile').val()=='')$('#invoice_vehicle_mobile').next('span').css({'color':'#F00'});
			else if(invv==3 && $('#invoice_vehicle_natural').val()=='')$('#invoice_vehicle_natural').next('span').css({'color':'#F00'});
		}else if(invt==3){
			if($('#order_invoice_id').val()==''){$('#order_invoice_id').next('span').show().css({'color':'#F00'});msg+=$('#order_invoice_id').next('span').html()+br;}
			else $('#order_invoice_id').next('span').hide();
			if($('#order_invoice_title').val()==''){$('#order_invoice_title').next('span').show();msg+=$('#order_invoice_title').next('span').html()+br}
			else $('#order_invoice_title').next('span').hide();
			if($('#order_invoice_addr').val()=='')$('#order_invoice_addr').next('span').show();
			else $('#order_invoice_addr').next('span').hide();
		}
	}
	if($('#invoice_live_code_input').length>0)invl=$('#invoice_live_code_input').val();
	if($('#invoice_vehicle_mobile').length>0){invm=$('#invoice_vehicle_mobile').val();}
	if(invm!=''){
		if($('#invoice_vehicle_mobile_conf').val()=='')msg+=language.invoice_veh_mobconf+br;
		else if($('#invoice_vehicle_mobile_conf').val()!=invm)msg+=language.invoice_veh_nmh+br;
	}
	if($('#invoice_vehicle_natural').length>0)invn=$('#invoice_vehicle_natural').val();
	if(invn!=''){
		if($('#invoice_vehicle_natural_conf').val()=='')msg+=language.invoice_veh_natconf+br;
		else if($('#invoice_vehicle_natural_conf').val()!=invn)msg+=language.invoice_veh_nmn+br;
	}
	if(invt==3 && ($('#order_invoice_id').val()=='' || $('#order_invoice_title').val()=='' || $('#order_invoice_addr').val()=='') )msg+=language.invoice_comp_nd;
	if(msg!='') jAlert(msg);
	else{
		$.ajax({type: "POST",dataType: 'json', url: "checkout.php?f=getdeliverdoodform",async:false,
		data: "checkout_type="+st+'&deliver_name='+encodeURIComponent(na)+'&deliv_email='+encodeURIComponent(ea)+'&deliv_add='+encodeURIComponent(adr)+'&deliv_zip='+zip+'&deliv_tel='+encodeURIComponent(tel)+'&deliv_mobile='+encodeURIComponent(mob)+'&good_order_memo_input='+encodeURIComponent(good_order_memo_input)+'&tws='+tws+'&cfd='+cfd+'&peri='+peri+'&order_people_name='+encodeURIComponent(opn)+ '&order_people_tel='+ encodeURIComponent(opt)+ '&order_people_email='+encodeURIComponent(ope)+ '&order_invoice_title='+ encodeURIComponent(oit)+ '&order_invoice_addr='+encodeURIComponent(oia)+ '&order_invoice_id='+oiad+'&bsp='+bsp+'&invoice_type_select='+invt+'&invoice_vehicle_type='+invv+'&invoice_live_code_input='+encodeURIComponent(invl)+'&invoice_vehicle_mobile='+encodeURIComponent(invm)+'&invoice_vehicle_natural='+encodeURIComponent(invn)+ '&stillgetpaperinvoice='+inpg+'&token='+ encodeURIComponent($('#token').val()),
		success: function(ret){
				   if(ret.stat==1 && $('#cart_info_float_div').length>0)$('#cart_info_float_div').html('').hide();
				   if(ret.list!='')$('#main_content').html(decodeURIComponent(ret.list));
				   if(ret.message!='')jAlert(decodeURIComponent(ret.message));
					if(ret.gtcf==1 && ret.ajs!='' && ret.order_sn!=''){
						$.getScript(decodeURIComponent(ret.ajs),function(){getCFdata(ret.order_sn);})
					}
				}
		});
	}
	$('#checkout_form input:submit').prop('disabled',false );
	return false;
}
function checkBonusMax(){
	var a,b,c,d,t;
	a=$('#use_bonus_point').val();
	b=parseInt($('#use_bonus_point_max').html(),10);
	c=parseInt($('#bonus_tomoney_r').html(),10);
	t=$('#goods_car_total_money_span').length>0?parseInt($('#goods_car_total_money_span').html(),10):0;
	if(a!=''){a=parseInt(a,10);
		if(a>b){a=b; $('#use_bonus_point').val(b)}
		d=Math.floor(a/c);
		$('#bonus_tomoney').html(d);
		if(!isNaN(t) && t>0)$('#total_order_money').html(t-d);
		if($('input:radio[name=tran_item_check]').length>0){$('input:radio[name=tran_item_check]').each(function(){$(this).prop('checked',false)});}
	}
}
function feedbackTxt(){
	var capt ='';
	var id=$('#htid').val();
	var name=$('#feedback_user_name').val();
	var ema=$('#feedback_user_email').val();
		if(ema!='' &&  !(Tools.isEmail(ema))){ jAlert(language.weminc+"\n"); $('#feedback_user_email').focus(); return false;}
	var cont=$.trim($('#feedback_content').val());
	if(name=='' || name.length<2){ jAlert(language.wynmemp); $('#feedback_user_name').focus(); return false;}
	if(cont=='' || cont.length<6){ jAlert(language.wcl2sh); $('#feedback_content').focus(); return false;}
	if($('.captcha_img').length>0){
		capt = $('#captch_input').val();
		if(capt==''){jAlert(language.captneed);$('#captch_input').focus();return false;}
	}
	if(parseInt(id,10)>0 && name.length>1 && cont.length>=6){
		$.ajax({type: "POST",dataType: 'json', url: "/gotodoit.php?f=sendtxtfeedback",
			   data: "htid="+id+'&feedback_user_name='+encodeURIComponent(name)+'&feedback_user_email='+encodeURIComponent(ema)+'&feedback_content='+encodeURIComponent(cont)+'&captcha='+capt,
			   beforeSend :function(){$('#submit_feedback').prop('disabled','disabled');},
			   success: function(ret){
				   if(ret.stat==1){if($('#feedback_content').length>0)$('#feedback_content').val('');$('.captcha_img').click();}
				   if(ret.message!='')jAlert(decodeURIComponent(ret.message));
				   $('#submit_feedback').prop('disabled',false);
				},
				complete :function(){$('#submit_feedback').prop('disabled',false);}
		});
	}else{jAlert(language.wynmemp+','+language.wcl2sh);}
}
function feedbackGood(){
	var capt ='';
	var id=$('#htid').val();var name=$('#feedback_user_name').val();var ema=$('#feedback_user_email').val();
	if(ema!='' &&  !(Tools.isEmail(ema))){ jAlert(language.weminc+"\n"); $('#feedback_user_email').focus(); return false;}
	var cont=$.trim($('#feedback_content').val());
	if(name=='' || name.length<2){ jAlert(language.wynmemp); $('#feedback_user_name').focus(); return false;}
	if(cont=='' || cont.length<6){ jAlert(language.wcl2sh); $('#feedback_content').focus(); return false;}
	if($('.captcha_img').length>0){
		capt = $('#captch_input').val();
		if(capt==''){jAlert(language.captneed);$('#captch_input').focus();return false;}
	}
	if(parseInt(id,10)>0 && name.length>2 && cont.length>=6){
		$.ajax({type: "POST",dataType: 'json', url: "/gotodoit.php?f=sendgoodfeedback",
			data: "htid="+id+'&feedback_user_name='+encodeURIComponent(name)+'&feedback_user_email='+encodeURIComponent(ema)+'&feedback_content='+encodeURIComponent(cont)+'&captcha='+capt,
			beforeSend :function(){$('#submit_feedback').prop('disabled','disabled');},
			success: function(ret){
				if(ret.stat==1){if($('#feedback_content').length>0)$('#feedback_content').val('');$('.captcha_img').click();}
				if(ret.message!='')jAlert(decodeURIComponent(ret.message));
			},
			complete :function(){$('#submit_feedback').prop('disabled',false);}
			});}
}
function getMoreFeedback(iid,pd,tid){
	if(isNaN(tid) || typeof(tid)=='undefined')tid=2;
	if(!isNaN(iid) &&  !isNaN(pd)){
		$('#feedback_content_pg_nav_div').remove();
		$.ajax({type: "POST",dataType: 'json', url: "/gotodoit.php?f=getmorefeedback",
			data: "id="+parseInt(iid,10)+'&pg='+parseInt(pd,10)+ '&tt='+tid,
			success: function(ret){
				if(ret.stat==1){if($('#feedback_content_list_div').length>0)$('#feedback_content_list_div').append(decodeURIComponent(ret.list));}
				if(ret.message!='')jAlert(decodeURIComponent(ret.message));
			}});}
}
function copyOrderPeopleToDeliver(){
	if($('#copy_order_people_to_deliver').length>0){
		if($('#copy_order_people_to_deliver').prop('checked')){
			$('#deliver_name').val($('#order_people_name').val());
			$('#deliv_email').val($('#order_people_email').val());
			$('#deliv_tel').val($('#order_people_tel').val());
		}
	}
}
function calculateGoogTypeAddPrice(){
	var tt=0;
	$('.good_type_checkbox_class').each(function(i){
		if($(this).prop('checked')==true){
			if($(this).hasClass('main_good_price')){
				$('#goodsPrice').html(parseInt($(this).next().html(),10));
				if($('#group_goodprice').length>0)$('#group_goodprice').html(parseInt($(this).next().html(),10));
			} 
			else tt+=parseInt($(this).next().html(),10);
		} 
	});
	
	$('.good_type_select_class').each(function(){
		if($('option:selected',this).attr('rel')!='')tt+=parseInt($('option:selected',this).attr('rel'),10);
	});
	
	$('#good_total_price_div').show();
	var gn=$('#good_need_num').val();
	if(isNaN(gn)){$('#good_need_num').val(1);gn=1;}
	else{gn=parseInt(gn,10);}
	if($('#group_goodprice').length>0){
		$('#good_total_price_span').html( (parseInt($('#group_goodprice').html(),10)+tt)*gn);
	}else $('#good_total_price_span').html((parseInt($('.goodsPrice').html())+tt)*gn);
	if( $('#price_rgp1_green').length>0 && $('#price_rgp1_total_span').length>0)$('#price_rgp1_total_span').html(' x '+gn +'=' + parseInt($('#price_rgp1_green').html(),10)*gn);
}
function loginChk(form_id){
	if( $('#'+form_id).length>0){
		$.post("/support_function.php?f=userlogin",$('#'+form_id).serialize(), function (res) {
			if( res.state==1){
				if( res.oth && $('#user_login_form_div').length>0){
					$('#user_login_form_div').after(URLdecode(res.oth));
					$('#user_login_form_div').remove();
				}
				if( res.message!='')jAlert(res.message);
			}
		},"json")
	}
}
function openProductDetailBox(gid){
	if(isNaN(gid))return ;else{
		$.ajax({type: "POST",dataType: 'json', url: "/support_function/getProductBox/?id="+parseInt(gid,10),
			data: "id="+parseInt(gid,10),
			success: function(ret){
				if(ret.state==1){$.colorbox({html:decodeURIComponent(ret.list)});}
				if(ret.message!='')jAlert(decodeURIComponent(ret.message));
			}});
	}
}
function printScreen(oid){
	if($('#'+oid).length>0){
		var a= $('#'+oid).html();
		var printPage = window.open("","printPage","");
		printPage.document.open();
		printPage.document.write("<HTML><head></head><BODY onload='window.print();'>");
		printPage.document.write("<PRE>");
		printPage.document.write(a);
		printPage.document.write("</PRE>");
		printPage.document.close("</BODY></HTML>");
	}
}
/*function jAlert(jcontent,jtitle,ctime){
	if(!jtitle)jtitle='';if(!jcontent)jcontent='';if(!ctime)ctime=0;else ctime=parseInt(ctime,10);
	if(jcontent!='' && jcontent!=null){var z=1;
		$('body>div').each(function(){if($(this).css('z-index')>=z)z=parseInt($(this).css('z-index'),10) +1;});
		$('#alert_div').html(jcontent).dialog({
			resizable:false, height:"auto",model:true,title:jtitle,
			buttons:{"確定":function(){$(this).dialog("close");return;}},
			open: function(){$('div.ui-dialog').css({'z-index':z});if(ctime>0){setTimeout("$('#alert_div').dialog('close')",ctime);}}
		});
		
	}
}*/
$.widget("ui.dialog", $.extend({}, $.ui.dialog.prototype, {
	_title: function(title) {
		if (!this.options.title ) {
			title.html("&#160;");
		} else {
			title.html(this.options.title);
		}
	}
}));
function jAlert(jcontent,jtitle,ctime, options){
	if(!jtitle)jtitle='<i class="fa fa-exclamation-circle" aria-hidden="true"></i>';if(!jcontent)jcontent='';if(!ctime)ctime=0;else ctime=parseInt(ctime,10);
	if(jcontent!='' && jcontent!=null){
		var z=101, $div = $('#dialog_box_div'),
			default_options ={css: {position:"fixed",top:"10%"}};
		options = $.extend({}, default_options, options);
		if(typeof options.buttons === 'undefined'){
			options.buttons = [{text:"OK", icon: "ui-icon-heart",
				click: function() {$( this ).dialog( "close" );}}]
		} else if( typeof options.buttons == 'string'){
			options.buttons = null;
		}

		$('body > div').each(function(){var a=parseInt($(this).css('z-index'),10); z=a>z?(a+1):z;});
		if( $div.length<1 ){
			$('body').append('<div id="dialog_box_div"></div>'); $div= $('#dialog_box_div');
		}
		$div.html(jcontent).dialog({
			resizable:false, height:"auto",model:true,
			title:jtitle,
			buttons: options.buttons ,
			open: function(){
				var tid = '#dialog_box_div+div.ui-dialog-buttonpane';
				if(ctime>0){
					if( $(tid+' span.alert_countdown').length<1 )$(tid+' div.ui-dialog-buttonset').prepend('<span class="alert_countdown"></span>秒關閉');
					$(tid+' span.alert_countdown').text( parseInt(ctime/1000 , 10)  );
					alert_countdown=setInterval(function () { if (ctime > 0) { $(tid + ' span.alert_countdown').text(parseInt(ctime / 1000, 10)); ctime-=1000;} else { clearInterval(alert_countdown); $('#dialog_box_div').dialog('close'); } }, 1000);
				}
				else {$(tid+' span.alert_countdown').text(0).hide();}
			},
			close: function(){
				if( typeof(alert_countdown )!= 'undefined')clearInterval(alert_countdown);
			}
		}).parent('div').css({'z-index':z, 'position': options.css.position, 'top':options.css.top});
	}
}


function URLdecode(str) {var ret="";for(var i=0;i<str.length;i++){var chr=str.charAt(i);if(chr=="+"){ret+=" ";}else if(chr=="%"){var asc=str.substring(i+1,i+3);if(parseInt("0x"+asc)>0x7f){ret+=decodeURI("%"+ str.substring(i+1,i+9));i += 8;}else {ret+=String.fromCharCode(parseInt("0x"+asc));i+=2;}}else{ret+=chr;}}return ret;}
var _gmx=0;var _gmy=0;
var jQuery_ver = 0;
$(document).ready(function() {
	if( typeof jQuery != 'undefined'){
		jQuery_ver = jQuery.fn.jquery;
	}
    //$('#checkout_form').submit(function(){goodCheckout(); return false;});
	$('#feedback_form').submit(function(){feedbackTxt(); return false;});
	$('#feedback_good_form').submit(function(){feedbackGood(); return false;});
	if( jQuery_ver < 1.9){
		$('.good_type_checkbox_class').live('click',function(){calculateGoogTypeAddPrice()});
		$('.good_type_select_class').live('change',function(){calculateGoogTypeAddPrice()});
		$('#good_need_num').live('keyup',function(){if($(this).val()!='')calculateGoogTypeAddPrice() });
	}else{
		$('body').on('click','.good_type_checkbox_class',function(){calculateGoogTypeAddPrice()})
			.on('change','.good_type_select_class',function(){calculateGoogTypeAddPrice()})
			.on('keyup','.good_need_num',function(){if($(this).val()!='')calculateGoogTypeAddPrice() })
		;
	}

	
	
	if($('div.organ_folder_menu ul').length>0){
		$('div.organ_folder_menu>ul>li').mouseenter(function(event){
			if($(this).find('ul').length==1){
				$('div.organ_folder_menu li').stop();
				var mouseX = event.pageX;var mouseY = event.pageY;
				var this_rel=$(this).attr('rel');
				if((Math.abs(mouseX-_gmx)+ Math.abs(mouseY-_gmy))>10){
					$('div.organ_folder_menu>ul>li').each(function(){
						if($(this).attr('rel')==this_rel ){
							$(this).children("ul").slideDown();
							_gmx=mouseX;_gmy=mouseY;
						}else $(this).children("ul").slideUp('fast');
					}); 
				}
			}
		});
	}
	
	$.getScript("/js/tools.js");
	if($('.captcha_img').length>0){
		$('.captcha_img').click(function(){
			$(this).attr('src','/captch_img.php?ti='+Math.random());
		});
	}
	/* if( $('#global_user_info_out_span').length>0){
		$('#global_user_info_out_span').click(function(){
			location.href=location.href+""
	})} */
	$('body')
		.on('submit','#shop_user_login_form',function(e){
			e.preventDefault();
			loginChk('shop_user_login_form');
			e.stopPropagation();
		})
		.on('click','.close_alert', function () {
			if($('#dialog_box_div').length>0)
				$('#dialog_box_div').dialog('close');
		})
		.on('submit','#checkout_form',function(e){
			e.preventDefault();
			goodCheckout();
			e.stopPropagation();
		})
		.on('click','#invoice_choose_div h3',function(){
			$(this).next().find('input[name=invoice_type_select]').eq(0).prop('checked',true);
			if( $('#invoice_type_select_1').prop('checked'))
				$('#invoice_vehicle_type_0').prop('checked',true);
		})
		.on('change','#invoice_donation_select', function () {
			$('#invoice_live_code_input').val( $(this).val());
		})
	;
});
